<!doctype html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini Liga – Round Robin</title>
  <style>
    /* OSTAJU ISTI STILOVI KOŠ ŠTO SAM IMAO RANIJE */
    :root{
      --bg:#0b0f14;
      --card:#0f1720;
      --muted:#9aa5b1;
      --accent:#7c9cff;
      --glass: rgba(255,255,255,0.04);
      --glass-strong: rgba(0,0,0,0.5);
      --radius:14px;
      --glass-border: rgba(255,255,255,0.04);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#e6eef6}
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image:url('logo.jpg');
      background-size:cover;
      background-position:center;
      opacity:0.09;
      filter:blur(1px) saturate(0.7);
      z-index:0;
    }
    body::after{
      content:"";
      position:fixed;
      inset:0;
      background:linear-gradient(180deg, rgba(2,6,11,0.6), rgba(2,8,14,0.9));
      z-index:0;
    }
    .container{
      position:relative;
      z-index:1;
      max-width:1150px;
      margin:36px auto;
      padding:28px;
      display:grid;
      gap:20px;
      grid-template-columns: 1fr 420px;
    }
    header{
      grid-column:1/-1;
      display:flex;
      align-items:center;
      gap:16px;
      padding:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:18px;
      box-shadow: 0 6px 20px rgba(2,8,20,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }
    header img{
      width:64px;height:64px;object-fit:contain;border-radius:10px;background:var(--glass-strong);padding:8px;
    }
    h1{font-size:20px;margin:0}
    .subtitle{color:var(--muted);font-size:13px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 8px 30px rgba(2,6,14,0.5);
      border:1px solid var(--glass-border);
    }
    .matches{
      display:flex;
      flex-direction:column;
      gap:12px;
      max-height:65vh;
      overflow:auto;
      padding-right:6px;
    }
    .match{
      display:grid;
      grid-template-columns: 1fr 1fr 110px;
      gap:8px;
      align-items:center;
      padding:10px;
      border-radius:12px;
      background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      transition: transform .18s ease, box-shadow .18s ease;
      border:1px solid rgba(255,255,255,0.02);
    }
    .match:hover{transform:translateY(-4px); box-shadow:0 10px 30px rgba(2,6,20,0.5)}
    .team{
      display:flex;
      gap:10px;
      align-items:center;
      font-weight:600;
    }
    .team small{color:var(--muted);font-weight:400}
    .score{
      display:flex;
      gap:8px;
      justify-content:center;
      align-items:center;
    }
    .score input{
      width:42px;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;color:inherit;text-align:center;font-weight:700;
    }
    .kolo{color:var(--muted);font-size:13px}
    .table-head{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px}
    .btn{
      background:linear-gradient(180deg,var(--accent), #5a7ef0);
      padding:10px 14px;border-radius:10px;color:white;font-weight:700;border:none;cursor:pointer;box-shadow:0 6px 20px rgba(92,124,255,0.18);
    }
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);font-weight:600}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .standings{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 56px 44px 44px 44px 56px 56px 64px 64px;
      gap:8px;
      align-items:center;
      padding:10px;border-radius:10px;
      background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px solid rgba(255,255,255,0.02);
    }
    .row.header{font-weight:700;color:var(--muted);font-size:13px}
    .row0{background:linear-gradient(90deg, rgba(124,156,255,0.03), rgba(124,156,255,0.01));}
    .team-name{font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .rank{font-weight:900;color:var(--accent)}
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
    }
    .modal-content {
      background: var(--card);
      margin: 15% auto;
      padding: 24px;
      border-radius: var(--radius);
      width: 300px;
      text-align: center;
      border: 1px solid var(--glass-border);
      box-shadow: 0 10px 40px rgba(2,6,20,0.8);
    }
    .modal input {
      width: 100%;
      padding: 12px;
      margin: 16px 0;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      color: white;
      text-align: center;
      font-size: 16px;
    }
    .modal-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    .status {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 12px;
      margin-top: 8px;
      text-align: center;
    }
    .status.success {
      background: rgba(34, 197, 94, 0.1);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }
    .status.error {
      background: rgba(239, 68, 68, 0.1);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    .status.loading {
      background: rgba(59, 130, 246, 0.1);
      color: #60a5fa;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }
    @media (max-width:980px){
      .container{grid-template-columns:1fr; padding:16px}
      .matches{max-height:55vh}
      .row{grid-template-columns: 1fr 40px 36px 36px 36px 46px 46px 56px 56px;font-size:14px}
    }
    .pulse{
      animation: pulse 700ms ease;
    }
    @keyframes pulse{
      0%{transform:scale(0.995);opacity:0.8}
      100%{transform:scale(1);opacity:1}
    }
    footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="logo.jpg" alt="logo" />
      <div>
        <h1>Mini Liga – Round Robin</h1>
        <div class="subtitle">8 timova • 14 kola (home & away) • Real-time rezultati</div>
      </div>
    </header>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div style="font-weight:800">Raspored utakmica</div>
          <div class="muted" style="font-size:13px">Unesi rezultate - automatski se sinhronizuju</div>
        </div>
        <div class="kolo">14 kola</div>
      </div>

      <div id="matches" class="matches"></div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button id="updateBtn" class="btn">Ažuriraj tabelu</button>
        <button id="clearBtn" class="btn ghost">Očisti rezultate</button>
        <button id="fillExample" class="btn ghost">Popuni primer</button>
        <button id="refreshBtn" class="btn ghost">Osveži</button>
      </div>
      <div id="status" class="status"></div>
    </section>

    <aside class="card">
      <div class="table-head">
        <div>
          <div style="font-weight:800">Tabela</div>
          <div class="muted" style="font-size:13px">Automatski prikaz po bodovima → gol razlika → dati golovi</div>
        </div>
        <div style="text-align:right">
          <div class="muted" style="font-size:12px">Timovi: 8</div>
          <div class="muted" style="font-size:12px">Kola: 14</div>
        </div>
      </div>

      <div id="standings" class="standings">
        <div class="row header">
          <div>Tim</div><div>U</div><div>W</div><div>D</div><div>L</div><div>GF</div><div>GA</div><div>GD</div><div>Pts</div>
        </div>
      </div>
    </aside>

    <footer class="muted">Real-time sinhronizacija • </footer>
  </div>

  <div id="passwordModal" class="modal">
    <div class="modal-content">
      <h3>Unesi šifru za brisanje</h3>
      <input type="password" id="passwordInput" placeholder="Šifra..." />
      <div class="modal-buttons">
        <button id="confirmClear" class="btn">Potvrdi</button>
        <button id="cancelClear" class="btn ghost">Otkaži</button>
      </div>
    </div>
  </div>

  <script>
    // Teams
    const TEAMS = ["Vladimir","Mirko","Uroš","Jovan","Lazar","Bojan","Miljan","Nikola"];
    const PASSWORD = "MNT123";
    
    // ⚠️ ZAMENI OVO SA TVOJIM PODACIMA ⚠️
    const JSONBIN_BIN_ID = '690c7853ae596e708f481ea8'; // Bin ID iz URL-a
    const JSONBIN_MASTER_KEY = '$2a$10$i8n78C9v1VhAsJ5894B07u1V0c/YWICUe9sXtgnB2OmOFDyOK3oi.'; // API Key iz Account Settings

    // Generate schedule
    function generateSchedule(teams){
      const t = [...teams];
      if (t.length % 2 !== 0) t.push(null);
      const n = t.length;
      const rounds = [];
      for (let r = 0; r < n - 1; r++){
        const pairs = [];
        for (let i = 0; i < n/2; i++){
          const a = t[i];
          const b = t[n - 1 - i];
          if (a && b) pairs.push([a,b]);
        }
        rounds.push(pairs);
        t.splice(1,0,t.pop());
      }
      const secondHalf = rounds.map(rnd => rnd.map(([h,g]) => [g,h]));
      return rounds.concat(secondHalf);
    }

    const schedule = generateSchedule(TEAMS);
    const matchesContainer = document.getElementById('matches');
    const matchesList = [];

    function renderMatches(){
      matchesContainer.innerHTML = '';
      schedule.forEach((round, idx) => {
        const roundNum = idx+1;
        const roundHeader = document.createElement('div');
        roundHeader.className = 'muted';
        roundHeader.style.margin = '6px 0 0 4px';
        roundHeader.textContent = `Kolo ${roundNum}`;
        matchesContainer.appendChild(roundHeader);
        round.forEach((pair, i) => {
          const [home, away] = pair;
          const matchEl = document.createElement('div');
          matchEl.className = 'match';
          matchEl.dataset.round = roundNum;
          matchEl.dataset.index = matchesList.length;

          const left = document.createElement('div');
          left.className = 'team';
          left.innerHTML = `<div style="font-size:13px">${home}</div><small class="muted"> (domaćin)</small>`;

          const right = document.createElement('div');
          right.className = 'team';
          right.style.justifySelf = 'end';
          right.innerHTML = `<small class="muted">(gost)</small><div style="font-size:13px">${away}</div>`;

          const score = document.createElement('div');
          score.className = 'score';
          const inputHome = document.createElement('input');
          inputHome.type = 'number'; inputHome.min = 0; inputHome.placeholder = '-';
          inputHome.dataset.side = 'home';
          const sep = document.createElement('div'); sep.textContent=':'; sep.style.opacity=0.6;fontWeight=700;
          const inputAway = document.createElement('input');
          inputAway.type = 'number'; inputAway.min = 0; inputAway.placeholder = '-';
          inputAway.dataset.side = 'away';

          score.appendChild(inputHome);
          score.appendChild(sep);
          score.appendChild(inputAway);

          matchEl.appendChild(left);
          matchEl.appendChild(right);
          matchEl.appendChild(score);

          matchesContainer.appendChild(matchEl);

          matchesList.push({
            home, away, el: matchEl, inputHome, inputAway, round: roundNum
          });
        });
      });
    }

    function computeStandings(){
      const stats = {};
      TEAMS.forEach(t => stats[t] = {team:t, played:0, win:0, draw:0, loss:0, gf:0, ga:0, gd:0, pts:0});

      matchesList.forEach(m => {
        const hVal = m.el.querySelector('input[data-side="home"]').value;
        const aVal = m.el.querySelector('input[data-side="away"]').value;
        if (hVal === '' || aVal === '') return;
        const h = parseInt(hVal,10);
        const a = parseInt(aVal,10);
        if (isNaN(h) || isNaN(a)) return;
        
        stats[m.home].played++;
        stats[m.away].played++;
        stats[m.home].gf += h;
        stats[m.home].ga += a;
        stats[m.away].gf += a;
        stats[m.away].ga += h;
        
        if (h > a){
          stats[m.home].win++; stats[m.home].pts += 3;
          stats[m.away].loss++;
        } else if (h < a){
          stats[m.away].win++; stats[m.away].pts += 3;
          stats[m.home].loss++;
        } else {
          stats[m.home].draw++; stats[m.away].draw++;
          stats[m.home].pts += 1; stats[m.away].pts += 1;
        }
      });

      TEAMS.forEach(t => { stats[t].gd = stats[t].gf - stats[t].ga; });

      const table = Object.values(stats).sort((a,b) => {
        if (b.pts !== a.pts) return b.pts - a.pts;
        if (b.gd !== a.gd) return b.gd - a.gd;
        if (b.gf !== a.gf) return b.gf - a.gf;
        return a.team.localeCompare(b.team);
      });

      return table;
    }

    function renderStandings(table){
      const container = document.getElementById('standings');
      container.querySelectorAll('.row:not(.header)').forEach(n => n.remove());
      table.forEach((r, idx) => {
        const div = document.createElement('div');
        div.className = 'row pulse' + (idx==0 ? ' row0':'');
        div.innerHTML = `
          <div class="team-name">${idx+1}. ${r.team}</div>
          <div class="muted">${r.played}</div>
          <div class="muted">${r.win}</div>
          <div class="muted">${r.draw}</div>
          <div class="muted">${r.loss}</div>
          <div class="muted">${r.gf}</div>
          <div class="muted">${r.ga}</div>
          <div class="muted">${r.gd}</div>
          <div class="rank">${r.pts}</div>
        `;
        container.appendChild(div);
        setTimeout(()=>div.classList.remove('pulse'),800);
      });
    }

    function showStatus(message, type = 'success') {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      setTimeout(() => {
        statusEl.textContent = '';
        statusEl.className = 'status';
      }, 3000);
    }

    function getResultsData() {
      const results = [];
      matchesList.forEach(m => {
        const homeScore = m.el.querySelector('input[data-side="home"]').value;
        const awayScore = m.el.querySelector('input[data-side="away"]').value;
        results.push({
          home: m.home,
          away: m.away,
          homeScore: homeScore || '',
          awayScore: awayScore || '',
          round: m.round
        });
      });
      return results;
    }

    function setResultsData(results) {
      results.forEach((result, index) => {
        if (index < matchesList.length) {
          matchesList[index].el.querySelector('input[data-side="home"]').value = result.homeScore;
          matchesList[index].el.querySelector('input[data-side="away"]').value = result.awayScore;
        }
      });
    }

    // JSONBin funkcije
    async function saveToJSONBin() {
      const results = getResultsData();
      const data = {
        teams: TEAMS,
        results: results,
        timestamp: new Date().toISOString(),
        standings: computeStandings()
      };

      try {
        showStatus('Čuvanje...', 'loading');
        
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': JSONBIN_MASTER_KEY,
            'X-Bin-Name': 'Mini Liga Results'
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          throw new Error(`JSONBin error: ${response.status}`);
        }

        showStatus('Rezultati sačuvani! Svi vide promene.');
      } catch (error) {
        console.error('Greška pri čuvanju:', error);
        showStatus('Greška pri čuvanju, koristim lokalnu memoriju', 'error');
        saveToLocalStorage();
      }
    }

    async function loadFromJSONBin() {
      try {
        showStatus('Učitavam rezultate...', 'loading');
        
        const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
          headers: {
            'X-Master-Key': JSONBIN_MASTER_KEY
          }
        });

        if (!response.ok) {
          throw new Error(`JSONBin error: ${response.status}`);
        }

        const result = await response.json();
        const data = result.record;
        
        if (data && data.results) {
          setResultsData(data.results);
          showStatus('Rezultati učitani sa servera!');
          return true;
        }
        return false;
      } catch (error) {
        console.error('Greška pri učitavanju:', error);
        showStatus('Nema konekcije, učitavam lokalne rezultate', 'error');
        return loadFromLocalStorage();
      }
    }

    function saveToLocalStorage() {
      const results = getResultsData();
      localStorage.setItem('miniLigaResults', JSON.stringify(results));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem('miniLigaResults');
      if (saved) {
        try {
          const results = JSON.parse(saved);
          setResultsData(results);
          return true;
        } catch (e) {
          console.error('Error loading from localStorage:', e);
        }
      }
      return false;
    }

    function showPasswordModal() {
      document.getElementById('passwordModal').style.display = 'block';
      document.getElementById('passwordInput').focus();
    }

    function hidePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
      document.getElementById('passwordInput').value = '';
    }

    let saveDebounce;
    function scheduleSave() {
      clearTimeout(saveDebounce);
      saveDebounce = setTimeout(() => {
        saveToJSONBin();
      }, 1000);
    }

    // init
    renderMatches();
    
    document.addEventListener('DOMContentLoaded', async function() {
      if (await loadFromJSONBin()) {
        const table = computeStandings();
        renderStandings(table);
      } else {
        renderStandings(TEAMS.map(t => ({team:t, played:0, win:0, draw:0, loss:0, gf:0, ga:0, gd:0, pts:0})));
        showStatus('Kreirana nova liga - unesi rezultate');
      }
    });

    document.getElementById('updateBtn').addEventListener('click',()=>{
      const table = computeStandings();
      renderStandings(table);
      saveToJSONBin();
    });

    document.getElementById('refreshBtn').addEventListener('click', async ()=>{
      if (await loadFromJSONBin()) {
        const table = computeStandings();
        renderStandings(table);
        showStatus('Rezultati osveženi!');
      }
    });

    document.getElementById('clearBtn').addEventListener('click', showPasswordModal);

    document.getElementById('confirmClear').addEventListener('click', async function() {
      const password = document.getElementById('passwordInput').value;
      if (password === PASSWORD) {
        matchesList.forEach(m => {
          m.el.querySelector('input[data-side="home"]').value = '';
          m.el.querySelector('input[data-side="away"]').value = '';
        });
        renderStandings(TEAMS.map(t => ({team:t, played:0, win:0, draw:0, loss:0, gf:0, ga:0, gd:0, pts:0})));
        
        const emptyData = {
          teams: TEAMS,
          results: getResultsData(),
          timestamp: new Date().toISOString(),
          standings: TEAMS.map(t => ({team:t, played:0, win:0, draw:0, loss:0, gf:0, ga:0, gd:0, pts:0}))
        };
        
        await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Master-Key': JSONBIN_MASTER_KEY
          },
          body: JSON.stringify(emptyData)
        });
        
        localStorage.removeItem('miniLigaResults');
        
        hidePasswordModal();
        showStatus('Svi rezultati obrisani! Možeš početi novu ligu.');
      } else {
        alert('Pogrešna šifra!');
        document.getElementById('passwordInput').value = '';
      }
    });

    document.getElementById('cancelClear').addEventListener('click', hidePasswordModal);

    document.getElementById('fillExample').addEventListener('click',()=>{
      matchesList.forEach((m, i) => {
        const a = Math.floor(Math.random()*4);
        const b = Math.floor(Math.random()*4);
        m.el.querySelector('input[data-side="home"]').value = a;
        m.el.querySelector('input[data-side="away"]').value = b;
      });
      document.getElementById('updateBtn').click();
    });

    let debounce;
    matchesContainer.addEventListener('input', ()=>{
      clearTimeout(debounce);
      debounce = setTimeout(()=> {
        const table = computeStandings();
        renderStandings(table);
        scheduleSave();
      }, 700);
    });

    window.addEventListener('click', function(event) {
      const modal = document.getElementById('passwordModal');
      if (event.target === modal) {
        hidePasswordModal();
      }
    });

    setInterval(async () => {
      if (await loadFromJSONBin()) {
        const table = computeStandings();
        renderStandings(table);
      }
    }, 30000);
  </script>
</body>
</html>
